<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <meta content="ie=edge" http-equiv="x-ua-compatible"/>
  <meta content="Copy to clipboard" name="lang:clipboard.copy"/>
  <meta content="Copied to clipboard" name="lang:clipboard.copied"/>
  <meta content="en" name="lang:search.language"/>
  <meta content="True" name="lang:search.pipeline.stopwords"/>
  <meta content="True" name="lang:search.pipeline.trimmer"/>
  <meta content="No matching documents" name="lang:search.result.none"/>
  <meta content="1 matching document" name="lang:search.result.one"/>
  <meta content="# matching documents" name="lang:search.result.other"/>
  <meta content="[\s\-]+" name="lang:search.tokenizer"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&amp;display=fallback" rel="stylesheet"/>
  <style>
   body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
  </style>
  <link href="../../_static/stylesheets/application.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-palette.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-fixes.css" rel="stylesheet"/>
  <link href="../../_static/fonts/material-icons.css" rel="stylesheet"/>
  <meta content="#3f51b5" name="theme-color"/>
  <script src="../../_static/javascripts/modernizr.js">
  </script>
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MJ7RHW2FRB">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-MJ7RHW2FRB');
  </script>
  <title>
   tortoise.models — Tortoise ORM v0.17.8 Documentation
  </title>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/material.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <link href="../../_static/tortoise.png" rel="shortcut icon"/>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
 </head>
 <body data-md-color-accent="light-green" data-md-color-primary="green" dir="ltr">
  <svg class="md-svg">
   <defs data-children-count="0">
    <svg height="448" id="__github" viewbox="0 0 416 448" width="416" xmlns="http://www.w3.org/2000/svg">
     <path d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z" fill="currentColor">
     </path>
    </svg>
   </defs>
  </svg>
  <input class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
  <input class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
  <label class="md-overlay" data-md-component="overlay" for="__drawer">
  </label>
  <a class="md-skip" href="#_modules/tortoise/models" tabindex="1">
   Skip to content
  </a>
  <header class="md-header" data-md-component="header">
   <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
     <div class="md-flex__cell md-flex__cell--shrink">
      <a class="md-header-nav__button md-logo" href="../../toc.html" title="Tortoise ORM v0.17.8 Documentation">
       <img alt="Tortoise ORM 0.17.8 Documentation logo" height="26" src="../../_static/tortoise.png"/>
      </a>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer">
      </label>
     </div>
     <div class="md-flex__cell md-flex__cell--stretch">
      <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
       <span class="md-header-nav__topic">
        Tortoise ORM
       </span>
       <span class="md-header-nav__topic">
        tortoise.models
       </span>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--search md-header-nav__button" for="__search">
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
       <label class="md-search__overlay" for="__search">
       </label>
       <div class="md-search__inner" role="search">
        <form action="../../search.html" class="md-search__form" method="get" name="search">
         <input autocapitalize="off" autocomplete="off" class="md-search__input" data-md-component="query" data-md-state="active" name="q" placeholder="Search" spellcheck="false" type="text"/>
         <label class="md-icon md-search__icon" for="__search">
         </label>
         <button class="md-icon md-search__icon" data-md-component="reset" tabindex="-1" type="reset">
          
         </button>
        </form>
        <div class="md-search__output">
         <div class="md-search__scrollwrap" data-md-scrollfix="">
          <div class="md-search-result" data-md-component="result">
           <div class="md-search-result__meta">
            Type to start searching
           </div>
           <ol class="md-search-result__list">
           </ol>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <div class="md-header-nav__source">
       <a class="md-source" data-md-source="github" href="https://github.com/tortoise/tortoise-orm" title="Go to repository">
        <div class="md-source__icon">
         <svg height="28" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <use height="24" width="24" xlink:href="#__github">
          </use>
         </svg>
        </div>
        <div class="md-source__repository">
         tortoise-orm
        </div>
       </a>
      </div>
     </div>
     <script src="../../_static/javascripts/version_dropdown.js">
     </script>
     <script>
      var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
     </script>
    </div>
   </nav>
  </header>
  <div class="md-container">
   <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
     <ul class="md-tabs__list">
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="../index.html">
        Module code
       </a>
      </li>
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="../tortoise.html">
        tortoise
       </a>
      </li>
     </ul>
    </div>
   </nav>
   <main class="md-main">
    <div class="md-main__inner md-grid" data-md-component="container">
     <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--primary" data-md-level="0">
         <label class="md-nav__title md-nav__title--site" for="__drawer">
          <a class="md-nav__button md-logo" href="../../toc.html" title="Tortoise ORM v0.17.8 Documentation">
           <img alt=" logo" height="48" src="../../_static/tortoise.png" width="48"/>
          </a>
          <a href="../../toc.html" title="Tortoise ORM v0.17.8 Documentation">
           Tortoise ORM
          </a>
         </label>
         <div class="md-nav__source">
          <a class="md-source" data-md-source="github" href="https://github.com/tortoise/tortoise-orm" title="Go to repository">
           <div class="md-source__icon">
            <svg height="28" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
             <use height="24" width="24" xlink:href="#__github">
             </use>
            </svg>
           </div>
           <div class="md-source__repository">
            tortoise-orm
           </div>
          </a>
         </div>
         <ul class="md-nav__list">
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../index.html">
            Tortoise ORM
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../getting_started.html">
            Getting started
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../reference.html">
            Reference
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../examples.html">
            Examples
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../contrib.html">
            Contrib
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CHANGELOG.html">
            Changelog
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../roadmap.html">
            Roadmap
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CONTRIBUTING.html">
            Contribution Guide
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CONTRIBUTORS.html">
            Thanks
           </a>
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--secondary">
         <ul class="md-nav__list" data-md-scrollfix="">
          <li class="md-nav__item" id="searchbox">
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-content">
      <article class="md-content__inner md-typeset" role="main">
       <h1 id="modules-tortoise-models--page-root">
        Source code for tortoise.models
       </h1>
       <div class="highlight">
        <pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pypika</span> <span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">pypika.terms</span> <span class="kn">import</span> <span class="n">Term</span>

<span class="kn">from</span> <span class="nn">tortoise.backends.base.client</span> <span class="kn">import</span> <span class="n">BaseDBAsyncClient</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConfigurationError</span><span class="p">,</span>
    <span class="n">DoesNotExist</span><span class="p">,</span>
    <span class="n">IncompleteInstanceError</span><span class="p">,</span>
    <span class="n">IntegrityError</span><span class="p">,</span>
    <span class="n">OperationalError</span><span class="p">,</span>
    <span class="n">ParamsError</span><span class="p">,</span>
    <span class="n">TransactionManagementError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tortoise.fields.base</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">tortoise.fields.data</span> <span class="kn">import</span> <span class="n">IntField</span>
<span class="kn">from</span> <span class="nn">tortoise.fields.relational</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BackwardFKRelation</span><span class="p">,</span>
    <span class="n">BackwardOneToOneRelation</span><span class="p">,</span>
    <span class="n">ForeignKeyFieldInstance</span><span class="p">,</span>
    <span class="n">ManyToManyFieldInstance</span><span class="p">,</span>
    <span class="n">ManyToManyRelation</span><span class="p">,</span>
    <span class="n">NoneAwaitable</span><span class="p">,</span>
    <span class="n">OneToOneFieldInstance</span><span class="p">,</span>
    <span class="n">ReverseRelation</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tortoise.filters</span> <span class="kn">import</span> <span class="n">get_filters_for_field</span>
<span class="kn">from</span> <span class="nn">tortoise.functions</span> <span class="kn">import</span> <span class="n">Function</span>
<span class="kn">from</span> <span class="nn">tortoise.indexes</span> <span class="kn">import</span> <span class="n">Index</span>
<span class="kn">from</span> <span class="nn">tortoise.manager</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="kn">from</span> <span class="nn">tortoise.queryset</span> <span class="kn">import</span> <span class="n">BulkUpdateQuery</span><span class="p">,</span> <span class="n">ExistsQuery</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">,</span> <span class="n">QuerySetSingle</span><span class="p">,</span> <span class="n">RawSQLQuery</span>
<span class="kn">from</span> <span class="nn">tortoise.router</span> <span class="kn">import</span> <span class="n">router</span>
<span class="kn">from</span> <span class="nn">tortoise.signals</span> <span class="kn">import</span> <span class="n">Signals</span>
<span class="kn">from</span> <span class="nn">tortoise.transactions</span> <span class="kn">import</span> <span class="n">current_transaction_map</span><span class="p">,</span> <span class="n">in_transaction</span>

<span class="n">MODEL</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"MODEL"</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">"Model"</span><span class="p">)</span>
<span class="n">EMPTY</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>


<span class="c1"># TODO: Define Filter type object. Possibly tuple?</span>


<span class="k">def</span> <span class="nf">get_together</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="s2">"Model.Meta"</span><span class="p">,</span> <span class="n">together</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
    <span class="n">_together</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">together</span><span class="p">,</span> <span class="p">())</span>

    <span class="k">if</span> <span class="n">_together</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_together</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_together</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_together</span> <span class="o">=</span> <span class="p">(</span><span class="n">_together</span><span class="p">,)</span>

    <span class="c1"># return without validation, validation will be done further in the code</span>
    <span class="k">return</span> <span class="n">_together</span>


<span class="k">def</span> <span class="nf">prepare_default_ordering</span><span class="p">(</span><span class="n">meta</span><span class="p">:</span> <span class="s2">"Model.Meta"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
    <span class="n">ordering_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"ordering"</span><span class="p">,</span> <span class="p">())</span>

    <span class="n">parsed_ordering</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="n">QuerySet</span><span class="o">.</span><span class="n">_resolve_ordering_string</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span> <span class="k">for</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="n">ordering_list</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">parsed_ordering</span>


<span class="k">def</span> <span class="nf">_fk_setter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="s2">"Model"</span><span class="p">,</span>
    <span class="n">value</span><span class="p">:</span> <span class="s2">"Optional[Model]"</span><span class="p">,</span>
    <span class="n">_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">relation_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">to_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation_field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">to_field</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fk_getter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="s2">"Model"</span><span class="p">,</span> <span class="n">_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span> <span class="n">relation_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_field</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relation_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ftype</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">to_field</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">NoneAwaitable</span>


<span class="k">def</span> <span class="nf">_rfk_getter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="s2">"Model"</span><span class="p">,</span> <span class="n">_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span> <span class="n">frelfield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_field</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReverseRelation</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">ReverseRelation</span><span class="p">(</span><span class="n">ftype</span><span class="p">,</span> <span class="n">frelfield</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">from_field</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_ro2o_getter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="s2">"Model"</span><span class="p">,</span> <span class="n">_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ftype</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span> <span class="n">frelfield</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">from_field</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySetSingle[Optional[Model]]"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">)</span>

    <span class="n">val</span> <span class="o">=</span> <span class="n">ftype</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">frelfield</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_field</span><span class="p">)})</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_m2m_getter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">:</span> <span class="s2">"Model"</span><span class="p">,</span> <span class="n">_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_object</span><span class="p">:</span> <span class="n">ManyToManyFieldInstance</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ManyToManyRelation</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">ManyToManyRelation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_object</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_get_comments</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">"""</span>
<span class="sd">    Get comments exactly before attributes</span>

<span class="sd">    It can be multiline comment. The placeholder "{model}" will be replaced with the name of the</span>
<span class="sd">    model class. We require that the comments are in #: (with a colon) format, so you can</span>
<span class="sd">    differentiate between private and public comments.</span>

<span class="sd">    :param cls: The class we need to extract comments from its source.</span>
<span class="sd">    :return: The dictionary of comments by field name</span>
<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>  <span class="c1"># pragma: nocoverage</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cls_</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls_</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"((?:(?!\n|^)[^\w\n]*#:.*?\n)+?)[^\w\n]*(\w+)\s*[:=]"</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Extract text</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">"(^\s*#:\s*|\s*$)"</span><span class="p">,</span> <span class="s2">""</span><span class="p">,</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="c1"># Class name template</span>
            <span class="n">comments</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="si">{model}</span><span class="s2">"</span><span class="p">,</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">comments</span>


<span class="k">class</span> <span class="nc">MetaInfo</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"abstract"</span><span class="p">,</span>
        <span class="s2">"db_table"</span><span class="p">,</span>
        <span class="s2">"app"</span><span class="p">,</span>
        <span class="s2">"fields"</span><span class="p">,</span>
        <span class="s2">"db_fields"</span><span class="p">,</span>
        <span class="s2">"m2m_fields"</span><span class="p">,</span>
        <span class="s2">"o2o_fields"</span><span class="p">,</span>
        <span class="s2">"backward_o2o_fields"</span><span class="p">,</span>
        <span class="s2">"fk_fields"</span><span class="p">,</span>
        <span class="s2">"backward_fk_fields"</span><span class="p">,</span>
        <span class="s2">"fetch_fields"</span><span class="p">,</span>
        <span class="s2">"fields_db_projection"</span><span class="p">,</span>
        <span class="s2">"_inited"</span><span class="p">,</span>
        <span class="s2">"fields_db_projection_reverse"</span><span class="p">,</span>
        <span class="s2">"filters"</span><span class="p">,</span>
        <span class="s2">"fields_map"</span><span class="p">,</span>
        <span class="s2">"default_connection"</span><span class="p">,</span>
        <span class="s2">"basequery"</span><span class="p">,</span>
        <span class="s2">"basequery_all_fields"</span><span class="p">,</span>
        <span class="s2">"basetable"</span><span class="p">,</span>
        <span class="s2">"_filters"</span><span class="p">,</span>
        <span class="s2">"unique_together"</span><span class="p">,</span>
        <span class="s2">"manager"</span><span class="p">,</span>
        <span class="s2">"indexes"</span><span class="p">,</span>
        <span class="s2">"pk_attr"</span><span class="p">,</span>
        <span class="s2">"generated_db_fields"</span><span class="p">,</span>
        <span class="s2">"_model"</span><span class="p">,</span>
        <span class="s2">"table_description"</span><span class="p">,</span>
        <span class="s2">"pk"</span><span class="p">,</span>
        <span class="s2">"db_pk_column"</span><span class="p">,</span>
        <span class="s2">"db_native_fields"</span><span class="p">,</span>
        <span class="s2">"db_default_fields"</span><span class="p">,</span>
        <span class="s2">"db_complex_fields"</span><span class="p">,</span>
        <span class="s2">"_default_ordering"</span><span class="p">,</span>
        <span class="s2">"_ordering_validated"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">:</span> <span class="s2">"Model.Meta"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"abstract"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span> <span class="n">Manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"manager"</span><span class="p">,</span> <span class="n">Manager</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"table"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"app"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_together</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_together</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"unique_together"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_together</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"indexes"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_ordering</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_default_ordering</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering_validated</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2m_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fk_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o2o_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_fk_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_o2o_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection_reverse</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inited</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basequery</span><span class="p">:</span> <span class="n">Query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basequery_all_fields</span><span class="p">:</span> <span class="n">Query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basetable</span><span class="p">:</span> <span class="n">Table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"pk_attr"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_db_fields</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">"Model"</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="s2">"table_description"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_pk_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_native_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Field</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_default_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Field</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_complex_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Field</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">def</span> <span class="nf">add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Field</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Field </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already present in meta"</span><span class="p">)</span>
        <span class="n">value</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">value</span><span class="o">.</span><span class="n">model_field_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">has_db_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">name</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ManyToManyFieldInstance</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m2m_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BackwardOneToOneRelation</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backward_o2o_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BackwardFKRelation</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backward_fk_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">field_filters</span> <span class="o">=</span> <span class="n">get_filters_for_field</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">source_field</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field_filters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalise_fields</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseDBAsyncClient</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current_transaction_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">default_connection</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">"No DB associated to model"</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ordering_validated</span><span class="p">:</span>
            <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ordering</span><span class="p">}</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"Unknown fields </span><span class="si">{</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">)</span><span class="si">}</span><span class="s2"> in "</span>
                <span class="sa">f</span><span class="s2">"default ordering for model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ordering</span>

    <span class="k">def</span> <span class="nf">get_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">finalise_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Finalise the model after it had been fully loaded.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finalise_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_filters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_lazy_fk_m2m_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_db_fields</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finalise_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection_reverse</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m2m_fields</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_fk_fields</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">fk_fields</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_o2o_fields</span>
            <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">o2o_fields</span>
        <span class="p">)</span>

        <span class="n">generated_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">generated</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">generated_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">model_field_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generated_db_fields</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">generated_fields</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ordering_validated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ordering</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ordering_validated</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_generate_lazy_fk_m2m_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create lazy FK fields on model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fk_fields</span><span class="p">:</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">fk_field_object</span><span class="p">:</span> <span class="n">ForeignKeyFieldInstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="n">relation_field</span> <span class="o">=</span> <span class="n">fk_field_object</span><span class="o">.</span><span class="n">source_field</span>
            <span class="n">to_field</span> <span class="o">=</span> <span class="n">fk_field_object</span><span class="o">.</span><span class="n">to_field_instance</span><span class="o">.</span><span class="n">model_field_name</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="nb">property</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_getter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">ftype</span><span class="o">=</span><span class="n">fk_field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_setter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_setter</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create lazy reverse FK fields on model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_fk_fields</span><span class="p">:</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">backward_fk_field_object</span><span class="p">:</span> <span class="n">BackwardFKRelation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="nb">property</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_rfk_getter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">ftype</span><span class="o">=</span><span class="n">backward_fk_field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                        <span class="n">frelfield</span><span class="o">=</span><span class="n">backward_fk_field_object</span><span class="o">.</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">from_field</span><span class="o">=</span><span class="n">backward_fk_field_object</span><span class="o">.</span><span class="n">to_field_instance</span><span class="o">.</span><span class="n">model_field_name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create lazy one to one fields on model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">o2o_fields</span><span class="p">:</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">o2o_field_object</span><span class="p">:</span> <span class="n">OneToOneFieldInstance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="n">relation_field</span> <span class="o">=</span> <span class="n">o2o_field_object</span><span class="o">.</span><span class="n">source_field</span>
            <span class="n">to_field</span> <span class="o">=</span> <span class="n">o2o_field_object</span><span class="o">.</span><span class="n">to_field_instance</span><span class="o">.</span><span class="n">model_field_name</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="nb">property</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_getter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">ftype</span><span class="o">=</span><span class="n">o2o_field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_setter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_fk_setter</span><span class="p">,</span>
                        <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">relation_field</span><span class="o">=</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">to_field</span><span class="o">=</span><span class="n">to_field</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create lazy reverse one to one fields on model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_o2o_fields</span><span class="p">:</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">backward_o2o_field_object</span><span class="p">:</span> <span class="n">BackwardOneToOneRelation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span>  <span class="c1"># type: ignore</span>
                <span class="n">key</span>
            <span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="nb">property</span><span class="p">(</span>
                    <span class="n">partial</span><span class="p">(</span>
                        <span class="n">_ro2o_getter</span><span class="p">,</span>
                        <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span>
                        <span class="n">ftype</span><span class="o">=</span><span class="n">backward_o2o_field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                        <span class="n">frelfield</span><span class="o">=</span><span class="n">backward_o2o_field_object</span><span class="o">.</span><span class="n">relation_field</span><span class="p">,</span>
                        <span class="n">from_field</span><span class="o">=</span><span class="n">backward_o2o_field_object</span><span class="o">.</span><span class="n">to_field_instance</span><span class="o">.</span><span class="n">model_field_name</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Create lazy M2M fields on model.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2m_fields</span><span class="p">:</span>
            <span class="n">_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">"</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span>
                <span class="n">key</span><span class="p">,</span>
                <span class="nb">property</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">_m2m_getter</span><span class="p">,</span> <span class="n">_key</span><span class="o">=</span><span class="n">_key</span><span class="p">,</span> <span class="n">field_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">])),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_db_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_default_fields</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_complex_fields</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_native_fields</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_fields</span><span class="p">:</span>
            <span class="n">model_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_db_projection_reverse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">model_field</span><span class="p">]</span>

            <span class="n">default_converter</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">to_python_value</span> <span class="ow">is</span> <span class="n">Field</span><span class="o">.</span><span class="n">to_python_value</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">field</span><span class="o">.</span><span class="n">skip_to_python_if_native</span>
                <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">field_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="o">.</span><span class="n">DB_NATIVE</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_native_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">default_converter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_complex_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">field_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="o">.</span><span class="n">DB_NATIVE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_native_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_default_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_generate_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">get_overridden_filter_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="o">.</span><span class="n">get_overridden_filter_func</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">filter_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">overridden_operator</span> <span class="o">=</span> <span class="n">get_overridden_filter_func</span><span class="p">(</span>
                <span class="n">filter_func</span><span class="o">=</span><span class="n">filter_info</span><span class="p">[</span><span class="s2">"operator"</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">overridden_operator</span><span class="p">:</span>
                <span class="n">filter_info</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">filter_info</span><span class="p">)</span>
                <span class="n">filter_info</span><span class="p">[</span><span class="s2">"operator"</span><span class="p">]</span> <span class="o">=</span> <span class="n">overridden_operator</span>  <span class="c1"># type: ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_info</span>


<span class="k">class</span> <span class="nc">ModelMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">fields_db_projection</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fields_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fk_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">m2m_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">o2o_fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">meta_class</span><span class="p">:</span> <span class="s2">"Model.Meta"</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"Meta"</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="s2">"Meta"</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{}))</span>
        <span class="n">pk_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"id"</span>

        <span class="c1"># Searching for Field attributes in the class hierarchy</span>
        <span class="k">def</span> <span class="nf">__search_for_field_attributes</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">"""</span>
<span class="sd">            Searching for class attributes of type fields.Field</span>
<span class="sd">            in the given class.</span>

<span class="sd">            If an attribute of the class is an instance of fields.Field,</span>
<span class="sd">            then it will be added to the fields dict. But only, if the</span>
<span class="sd">            key is not already in the dict. So derived classes have a higher</span>
<span class="sd">            precedence. Multiple Inheritance is supported from left to right.</span>

<span class="sd">            After checking the given class, the function will look into</span>
<span class="sd">            the classes according to the MRO (method resolution order).</span>

<span class="sd">            The MRO is 'natural' order, in which python traverses methods and</span>
<span class="sd">            fields. For more information on the magic behind check out:</span>
<span class="sd">            `The Python 2.3 Method Resolution Order</span>
<span class="sd">            &lt;https://www.python.org/download/releases/2.3/mro/&gt;`_.</span>
<span class="sd">            """</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">__search_for_field_attributes</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s2">"_meta"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
                <span class="c1"># For abstract classes</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="c1"># For abstract classes manager</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Manager</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For mixin classes</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                        <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Start searching for fields in the base classes.</span>
        <span class="n">inherited_attrs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="n">__search_for_field_attributes</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">inherited_attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inherited_attrs</span><span class="p">:</span>
            <span class="c1"># Ensure that the inherited fields are before the defined ones.</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inherited_attrs</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">"Model"</span><span class="p">:</span>
            <span class="n">custom_pk_present</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">custom_pk_present</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">"Can't create model </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> with two primary keys,"</span>
                                <span class="s2">" only single primary key is supported"</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">generated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">allows_generated</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">"Field '</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">' (</span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) can't be DB-generated"</span>
                            <span class="p">)</span>
                        <span class="n">custom_pk_present</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">pk_attr</span> <span class="o">=</span> <span class="n">key</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">custom_pk_present</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta_class</span><span class="p">,</span> <span class="s2">"abstract"</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">"id"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"id"</span><span class="p">:</span> <span class="n">IntField</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="o">**</span><span class="n">attrs</span><span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s2">"id"</span><span class="p">],</span> <span class="n">Field</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Can't create model </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> without explicit primary key if field 'id'"</span>
                        <span class="s2">" already present"</span>
                    <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">meta_class</span><span class="p">,</span> <span class="s2">"abstract"</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                    <span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">value</span><span class="o">.</span><span class="n">model_field_name</span> <span class="o">=</span> <span class="n">key</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">OneToOneFieldInstance</span><span class="p">):</span>
                        <span class="n">o2o_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ForeignKeyFieldInstance</span><span class="p">):</span>
                        <span class="n">fk_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ManyToManyFieldInstance</span><span class="p">):</span>
                        <span class="n">m2m_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fields_db_projection</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">key</span>
                        <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="n">get_filters_for_field</span><span class="p">(</span>
                                <span class="n">field_name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                <span class="n">field</span><span class="o">=</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                <span class="n">source_field</span><span class="o">=</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                            <span class="n">filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="n">get_filters_for_field</span><span class="p">(</span>
                                    <span class="n">field_name</span><span class="o">=</span><span class="s2">"pk"</span><span class="p">,</span>
                                    <span class="n">field</span><span class="o">=</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                    <span class="n">source_field</span><span class="o">=</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

        <span class="c1"># Clean the class attributes</span>
        <span class="k">for</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">fields_map</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">attrs</span><span class="p">[</span><span class="s2">"_meta"</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">MetaInfo</span><span class="p">(</span><span class="n">meta_class</span><span class="p">)</span>

        <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span> <span class="o">=</span> <span class="n">fields_map</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">fields_db_projection</span> <span class="o">=</span> <span class="n">fields_db_projection</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="n">filters</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">fk_fields</span> <span class="o">=</span> <span class="n">fk_fields</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">backward_fk_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">o2o_fields</span> <span class="o">=</span> <span class="n">o2o_fields</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">backward_o2o_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">m2m_fields</span> <span class="o">=</span> <span class="n">m2m_fields</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">default_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">pk_attr</span> <span class="o">=</span> <span class="n">pk_attr</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk_attr</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">db_pk_column</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">meta</span><span class="o">.</span><span class="n">pk_attr</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">_inited</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields_map</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">new_class</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">field</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">new_class</span>  <span class="c1"># type: ignore</span>

        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">_get_comments</span><span class="p">(</span><span class="n">new_class</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fields_map</span><span class="p">:</span>
                <span class="n">fields_map</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">docstring</span> <span class="o">=</span> <span class="n">comment</span>
                <span class="k">if</span> <span class="n">fields_map</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fields_map</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">new_class</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">meta</span><span class="o">.</span><span class="n">table_description</span><span class="p">:</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">table_description</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">cleandoc</span><span class="p">(</span><span class="n">new_class</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Manager</span><span class="p">):</span>
                <span class="n">value</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">new_class</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">new_class</span>  <span class="c1"># type: ignore</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">new_class</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">finalise_fields</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_class</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_getbypk</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../models.html#tortoise.models.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ModelMeta</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Base class for all Tortoise ORM Models.</span>
<span class="sd">    """</span>

    <span class="c1"># I don' like this here, but it makes auto completion and static analysis much happier</span>
    <span class="n">_meta</span> <span class="o">=</span> <span class="n">MetaInfo</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="n">_listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Signals</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore</span>
        <span class="n">Signals</span><span class="o">.</span><span class="n">pre_save</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">Signals</span><span class="o">.</span><span class="n">post_save</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">Signals</span><span class="o">.</span><span class="n">pre_delete</span><span class="p">:</span> <span class="p">{},</span>
        <span class="n">Signals</span><span class="o">.</span><span class="n">post_delete</span><span class="p">:</span> <span class="p">{},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># self._meta is a very common attribute lookup, lets cache it.</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_custom_generated_pk</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Assign defaults for missing fields</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)):</span>
            <span class="n">field_object</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">default</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span>

        <span class="c1"># Assign values and do type conversions</span>
        <span class="n">passed_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">*</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span> <span class="o">|</span> <span class="n">meta</span><span class="o">.</span><span class="n">fetch_fields</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">fk_fields</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">o2o_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">_saved_in_db</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"You should first call .save() on </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> before referring to it"</span>
                    <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">passed_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">source_field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">:</span>
                <span class="n">field_object</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">field_object</span><span class="o">.</span><span class="n">generated</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_custom_generated_pk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field_object</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is non nullable field, but null was passed"</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">to_python_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">backward_fk_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">"You can't set backward relations through init, change related model instead"</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">backward_o2o_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">"You can't set backward one to one relations through init,"</span>
                    <span class="s2">" change related model instead"</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">m2m_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s2">"You can't set m2m relations through init, use m2m_manager instead"</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">passed_fields</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_init_from_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_partial</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This is like so for performance reasons.</span>
            <span class="c1">#  We want to avoid conditionals and calling .to_python_value()</span>
            <span class="c1"># Native fields are fields that are already converted to/from python to DB type</span>
            <span class="c1">#  by the DB driver</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">db_native_fields</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="c1"># Fields that don't override .to_python_value() are converted without a call</span>
            <span class="c1">#  as we already know what we will be doing.</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">db_default_fields</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">model_field</span><span class="p">,</span>
                    <span class="kc">None</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">field</span><span class="o">.</span><span class="n">field_type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="c1"># These fields need manual .to_python_value()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta</span><span class="o">.</span><span class="n">db_complex_fields</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_field</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">to_python_value</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_partial</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># TODO: Apply similar perf optimisation as above for partial</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">to_python_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;"</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">&gt;"</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;"</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"Model instances without id are unhashable"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">pk</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span> <span class="nf">_get_pk_val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_pk_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">pk</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_pk_val</span><span class="p">,</span> <span class="n">_set_pk_val</span><span class="p">)</span>
    <span class="sd">"""</span>
<span class="sd">    Alias to the models Primary Key.</span>
<span class="sd">    Can be used as a field name when doing filtering e.g. ``.filter(pk=...)`` etc...</span>
<span class="sd">    """</span>

    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_getbypk</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no object </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<div class="viewcode-block" id="Model.clone"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="n">pk</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">EMPTY</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Create a new clone of the object that when you do a ``.save()`` will create a new record.</span>

<span class="sd">        :param pk: An optionally required value if the model doesn't generate its own primary key.</span>
<span class="sd">            Any value you specify here will always be used.</span>
<span class="sd">        :return: A copy of the current object without primary key information.</span>
<span class="sd">        :raises ParamsError: If pk is required but not provided.</span>
<span class="sd">        """</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="n">EMPTY</span><span class="p">:</span>
            <span class="n">pk_field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span>
            <span class="k">if</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">generated</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParamsError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> requires explicit primary key. Please use .clone(pk=&lt;value&gt;)"</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="n">pk</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Model.update_from_dict"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.update_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">update_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Updates the current model with the provided dict.</span>
<span class="sd">        This can allow mass-updating a model from a dict, also ensuring that datatype conversions happen.</span>

<span class="sd">        This will ignore any extra fields, and NOT update the model with them,</span>
<span class="sd">        but will raise errors on bad types or updating Many-instance relations.</span>

<span class="sd">        :param data: The parameters you want to update in a dict format</span>
<span class="sd">        :return: The current model instance</span>

<span class="sd">        :raises ConfigurationError: When attempting to update a remote instance</span>
<span class="sd">            (e.g. a reverse ForeignKey or ManyToMany relation)</span>
<span class="sd">        :raises ValueError: When a passed parameter is not type compatible</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_kwargs</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Model.register_listener"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.register_listener">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">register_listener</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="n">Signals</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Register listener to current model class for special Signal.</span>

<span class="sd">        :param signal: one of tortoise.signals.Signal</span>
<span class="sd">        :param listener: callable listener</span>

<span class="sd">        :raises ConfigurationError: When listener is not callable</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">listener</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s2">"Signal listener must be callable!"</span><span class="p">)</span>
        <span class="n">cls_listeners</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># type:ignore</span>
        <span class="k">if</span> <span class="n">listener</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_listeners</span><span class="p">:</span>
            <span class="n">cls_listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_pre_delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">listeners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cls_listeners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Signals</span><span class="o">.</span><span class="n">pre_delete</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">cls_listeners</span><span class="p">:</span>
            <span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">listener</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">using_db</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">listeners</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_post_delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">listeners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cls_listeners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Signals</span><span class="o">.</span><span class="n">post_delete</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">cls_listeners</span><span class="p">:</span>
            <span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">listener</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">using_db</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">listeners</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_pre_save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">listeners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cls_listeners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Signals</span><span class="o">.</span><span class="n">pre_save</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">cls_listeners</span><span class="p">:</span>
            <span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">using_db</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">listeners</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_post_save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">created</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">update_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">listeners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cls_listeners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Signals</span><span class="o">.</span><span class="n">post_save</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="n">cls_listeners</span><span class="p">:</span>
            <span class="n">listeners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">listener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="n">using_db</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">))</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">listeners</span><span class="p">)</span>

<div class="viewcode-block" id="Model.save"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.save">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">force_create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Creates/Updates the current model object.</span>

<span class="sd">        :param update_fields: If provided, it should be a tuple/list of fields by name.</span>

<span class="sd">            This is the subset of fields that should be updated.</span>
<span class="sd">            If the object needs to be created ``update_fields`` will be ignored.</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>
<span class="sd">        :param force_create: Forces creation of the record</span>
<span class="sd">        :param force_update: Forces updating of the record</span>

<span class="sd">        :raises IncompleteInstanceError: If the model is partial and the fields are not available for persistence.</span>
<span class="sd">        :raises IntegrityError: If the model can't be created or updated (specifically if force_create or force_update has been set)</span>
<span class="sd">        """</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">update_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">IncompleteInstanceError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is a partial model without primary key fetchd. Partial update not available"</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">IncompleteInstanceError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is a partial model, field '</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">' is not available"</span>
                        <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IncompleteInstanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is a partial model, can only be saved with the relevant update_field provided"</span>
                <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_save</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_create</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">force_update</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Can't update object that doesn't exist. PK: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="ow">or</span> <span class="n">update_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span>
                    <span class="n">created</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Do a merge/upsert operation here instead. Let the executor determine an optimal strategy for each DB engine.</span>
                <span class="k">await</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">created</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_save</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.delete"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.delete">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Deletes the current model object.</span>

<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>

<span class="sd">        :raises OperationalError: If object has never been persisted.</span>
<span class="sd">        """</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s2">"Can't delete unpersisted record"</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">execute_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_delete</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.fetch_related"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.fetch_related">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetch related fields.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            User.fetch_related("emails", "manager")</span>

<span class="sd">        :param args: The related fields that should be fetched.</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>
<span class="sd">        """</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_for_list</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.refresh_from_db"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.refresh_from_db">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">refresh_from_db</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Refresh latest data from db. When this method is called without arguments</span>
<span class="sd">        all db fields of the model are updated to the values currently present in the database.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            user.refresh_from_db(fields=['name'])</span>

<span class="sd">        :param fields: The special fields that to be refreshed.</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound.</span>

<span class="sd">        :raises OperationalError: If object has never been persisted.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_saved_in_db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OperationalError</span><span class="p">(</span><span class="s2">"Can't refresh unpersisted record"</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">QuerySet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">using_db</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">fields</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="k">await</span> <span class="n">qs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_choose_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">for_write</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return the connection that will be used if this query is executed now.</span>

<span class="sd">        :param for_write: Whether this query for write.</span>
<span class="sd">        :return: BaseDBAsyncClient:</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">for_write</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db</span>

<div class="viewcode-block" id="Model.get_or_create"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.get_or_create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MODEL</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetches the object if exists (filtering on the provided parameters),</span>
<span class="sd">        else creates an instance with any unspecified parameters as default values.</span>

<span class="sd">        :param defaults: Default values to be added to a created instance if it can't be fetched.</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>
<span class="sd">        :param kwargs: Query parameters.</span>
<span class="sd">        :raises IntegrityError: If create failed</span>
<span class="sd">        :raises TransactionManagementError: If transaction error</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">in_transaction</span><span class="p">(</span><span class="n">connection_name</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">connection_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">using_db</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">using_db</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">TransactionManagementError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">using_db</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Model.select_for_update"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.select_for_update">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">select_for_update</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">nowait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">skip_locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet select for update.</span>

<span class="sd">        Returns a queryset that will lock rows until the end of the transaction,</span>
<span class="sd">        generating a SELECT ... FOR UPDATE SQL statement on supported databases.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">(</span><span class="n">nowait</span><span class="p">,</span> <span class="n">skip_locked</span><span class="p">,</span> <span class="n">of</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.update_or_create"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.update_or_create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_or_create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">defaults</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MODEL</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        A convenience method for updating an object with the given kwargs, creating a new one if necessary.</span>

<span class="sd">        :param defaults: Default values used to update the object.</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>
<span class="sd">        :param kwargs: Query parameters.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">in_transaction</span><span class="p">(</span><span class="n">connection_name</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">connection_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">()</span><span class="o">.</span><span class="n">using_db</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span><span class="o">.</span><span class="n">get_or_none</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">instance</span><span class="o">.</span><span class="n">update_from_dict</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using_db</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>  <span class="c1"># type:ignore</span>
                <span class="k">return</span> <span class="n">instance</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.create"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Create a record in the DB and returns the object.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            user = await User.create(name="...", email="...")</span>

<span class="sd">        Equivalent to:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            user = User(name="...", email="...")</span>
<span class="sd">            await user.save()</span>

<span class="sd">        :param kwargs: Model parameters.</span>
<span class="sd">        """</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">_saved_in_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"using_db"</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using_db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">force_create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span></div>

<div class="viewcode-block" id="Model.bulk_update"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.bulk_update">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bulk_update</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BulkUpdateQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Update the given fields in each of the given objects in the database.</span>
<span class="sd">        This method efficiently updates the given fields on the provided model instances, generally with one query.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            users = [</span>
<span class="sd">                await User.create(name="...", email="..."),</span>
<span class="sd">                await User.create(name="...", email="...")</span>
<span class="sd">            ]</span>
<span class="sd">            users[0].name = 'name1'</span>
<span class="sd">            users[1].name = 'name2'</span>

<span class="sd">            await User.bulk_update(users, fields=['name'])</span>

<span class="sd">        :param objects: List of objects to bulk create</span>
<span class="sd">        :param fields: The fields to update</span>
<span class="sd">        :param batch_size: How many objects are created in a single query</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">bulk_update</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.in_bulk"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.in_bulk">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">in_bulk</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">id_list</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"pk"</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Return a dictionary mapping each of the given IDs to the object with</span>
<span class="sd">        that ID. If `id_list` isn't provided, evaluate the entire QuerySet.</span>

<span class="sd">        :param id_list: A list of field values</span>
<span class="sd">        :param field_name: Must be a unique field</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">in_bulk</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.bulk_create"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.bulk_create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">bulk_create</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Bulk insert operation:</span>

<span class="sd">        .. note::</span>
<span class="sd">            The bulk insert operation will do the minimum to ensure that the object</span>
<span class="sd">            created in the DB has all the defaults and generated fields set,</span>
<span class="sd">            but may be incomplete reference in Python.</span>

<span class="sd">            e.g. ``IntField`` primary keys will not be populated.</span>

<span class="sd">        This is recommend only for throw away inserts where you want to ensure optimal</span>
<span class="sd">        insert performance.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            User.bulk_create([</span>
<span class="sd">                User(name="...", email="..."),</span>
<span class="sd">                User(name="...", email="...")</span>
<span class="sd">            ])</span>

<span class="sd">        :param objects: List of objects to bulk create</span>
<span class="sd">        :param batch_size: How many objects are created in a single query</span>
<span class="sd">        :param using_db: Specific DB connection to use instead of default bound</span>
<span class="sd">        """</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">execute_bulk_insert</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.first"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.first">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="sd">"""</span>
<span class="sd">        Generates a QuerySet that returns the first record.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.filter"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.filter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Generates a QuerySet with the filter applied.</span>

<span class="sd">        :param args: Q functions containing constraints. Will be AND'ed.</span>
<span class="sd">        :param kwargs: Simple filter constraints.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.exclude"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.exclude">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">exclude</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Generates a QuerySet with the exclude applied.</span>

<span class="sd">        :param args: Q functions containing constraints. Will be AND'ed.</span>
<span class="sd">        :param kwargs: Simple filter constraints.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.annotate"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.annotate">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Function</span><span class="p">,</span> <span class="n">Term</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Annotates the result set with extra Functions/Aggregations/Expressions.</span>

<span class="sd">        :param kwargs: Parameter name and the Function/Aggregation to annotate with.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.all"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">QuerySet</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the complete QuerySet.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.get"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.get">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetches a single record for a Model type using the provided filter parameters.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            user = await User.get(username="foo")</span>

<span class="sd">        :param args: Q functions containing constraints. Will be AND'ed.</span>
<span class="sd">        :param kwargs: Simple filter constraints.</span>

<span class="sd">        :raises MultipleObjectsReturned: If provided search returned more than one object.</span>
<span class="sd">        :raises DoesNotExist: If object can not be found.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.raw"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.raw">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RawSQLQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Executes a RAW SQL and returns the result</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            result = await User.raw("select * from users where name like '%test%'")</span>

<span class="sd">        :param sql: The raw sql.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.exists"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.exists">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExistsQuery</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return True/False whether record exists with the provided filter parameters.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            result = await User.exists(username="foo")</span>

<span class="sd">        :param args: Q functions containing constraints. Will be AND'ed.</span>
<span class="sd">        :param kwargs: Simple filter constraints.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.get_or_none"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.get_or_none">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_or_none</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetches a single record for a Model type using the provided filter parameters or None.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            user = await User.get_or_none(username="foo")</span>

<span class="sd">        :param args: Q functions containing constraints. Will be AND'ed.</span>
<span class="sd">        :param kwargs: Simple filter constraints.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">get_or_none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.fetch_for_list"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.fetch_for_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch_for_list</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">instance_list</span><span class="p">:</span> <span class="s2">"Iterable[Model]"</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">using_db</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseDBAsyncClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetches related models for provided list of Model objects.</span>

<span class="sd">        :param instance_list: List of Model objects to fetch relations for.</span>
<span class="sd">        :param args: Relation names to fetch.</span>
<span class="sd">        :param using_db: DO NOT USE</span>
<span class="sd">        """</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">using_db</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">fetch_for_list</span><span class="p">(</span><span class="n">instance_list</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.check"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.check">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Calls various checks to validate the model.</span>

<span class="sd">        :raises ConfigurationError: If the model has not been configured correctly.</span>
<span class="sd">        """</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_together</span><span class="p">(</span><span class="s2">"unique_together"</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_together</span><span class="p">(</span><span class="s2">"indexes"</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_together</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">together</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Check the value of "unique_together" option.</span>

<span class="sd">        :raises ConfigurationError: If the model has not been configured correctly.</span>
<span class="sd">        """</span>
        <span class="n">_together</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="n">together</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_together</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">together</span><span class="si">}</span><span class="s2">' must be a list or tuple."</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unique_fields</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">Index</span><span class="p">))</span> <span class="k">for</span> <span class="n">unique_fields</span> <span class="ow">in</span> <span class="n">_together</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"All '</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">together</span><span class="si">}</span><span class="s2">' elements must be lists or tuples."</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">fields_tuple</span> <span class="ow">in</span> <span class="n">_together</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields_tuple</span><span class="p">,</span> <span class="n">Index</span><span class="p">):</span>
                <span class="n">fields_tuple</span> <span class="o">=</span> <span class="n">fields_tuple</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">fields_tuple</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">together</span><span class="si">}</span><span class="s2">' has no '</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">' field."</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ManyToManyFieldInstance</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">together</span><span class="si">}</span><span class="s2">' '</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">' field refers"</span>
                        <span class="s2">" to ManyToMany field."</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="Model.describe"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.describe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serializable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Describes the given list of models or ALL registered models.</span>

<span class="sd">        :param serializable:</span>
<span class="sd">            ``False`` if you want raw python objects,</span>
<span class="sd">            ``True`` for JSON-serializable data. (Defaults to ``True``)</span>

<span class="sd">        :return:</span>
<span class="sd">            A dictionary containing the model description.</span>

<span class="sd">            The base dict has a fixed set of keys that reference a list of fields</span>
<span class="sd">            (or a single field in the case of the primary key):</span>

<span class="sd">            .. code-block:: python3</span>

<span class="sd">                {</span>
<span class="sd">                    "name":                 str     # Qualified model name</span>
<span class="sd">                    "app":                  str     # 'App' namespace</span>
<span class="sd">                    "table":                str     # DB table name</span>
<span class="sd">                    "abstract":             bool    # Is the model Abstract?</span>
<span class="sd">                    "description":          str     # Description of table (nullable)</span>
<span class="sd">                    "docstring":            str     # Model docstring (nullable)</span>
<span class="sd">                    "unique_together":      [...]   # List of List containing field names that</span>
<span class="sd">                                                    #  are unique together</span>
<span class="sd">                    "pk_field":             {...}   # Primary key field</span>
<span class="sd">                    "data_fields":          [...]   # Data fields</span>
<span class="sd">                    "fk_fields":            [...]   # Foreign Key fields FROM this model</span>
<span class="sd">                    "backward_fk_fields":   [...]   # Foreign Key fields TO this model</span>
<span class="sd">                    "o2o_fields":           [...]   # OneToOne fields FROM this model</span>
<span class="sd">                    "backward_o2o_fields":  [...]   # OneToOne fields TO this model</span>
<span class="sd">                    "m2m_fields":           [...]   # Many-to-Many fields</span>
<span class="sd">                }</span>

<span class="sd">            Each field is specified as defined in :meth:`tortoise.fields.base.Field.describe`</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
            <span class="s2">"app"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app</span><span class="p">,</span>
            <span class="s2">"table"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
            <span class="s2">"abstract"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">table_description</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"docstring"</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">cleandoc</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="s2">""</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">"unique_together"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">unique_together</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="s2">"indexes"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span> <span class="ow">or</span> <span class="p">[],</span>
            <span class="s2">"pk_field"</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">),</span>
            <span class="s2">"data_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">"fk_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fk_fields</span>
            <span class="p">],</span>
            <span class="s2">"backward_fk_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">backward_fk_fields</span>
            <span class="p">],</span>
            <span class="s2">"o2o_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">o2o_fields</span>
            <span class="p">],</span>
            <span class="s2">"backward_o2o_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">backward_o2o_fields</span>
            <span class="p">],</span>
            <span class="s2">"m2m_fields"</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">field</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">serializable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">m2m_fields</span>
            <span class="p">],</span>
        <span class="p">}</span></div>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">MODEL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">MODEL</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">def</span> <span class="nf">_self</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">MODEL</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">_self</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

<div class="viewcode-block" id="Model.Meta"><a class="viewcode-back" href="../../models.html#tortoise.models.Model.Meta">[docs]</a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        The ``Meta`` class is used to configure metadata for the Model.</span>

<span class="sd">        Usage:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            class Foo(Model):</span>
<span class="sd">                ...</span>

<span class="sd">                class Meta:</span>
<span class="sd">                    table="custom_table"</span>
<span class="sd">                    unique_together=(("field_a", "field_b"), )</span>
<span class="sd">        """</span></div></div>
</pre>
       </div>
      </article>
     </div>
    </div>
   </main>
  </div>
  <footer class="md-footer">
   <div class="md-footer-nav">
    <nav class="md-footer-nav__inner md-grid">
    </nav>
   </div>
   <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
     <div class="md-footer-copyright">
      <div class="md-footer-copyright__highlight">
       © Copyright 2018 - 2021, Andrey Bondar &amp; Nickolas Grigoriadis &amp; long2ice.
      </div>
      Created using
      <a href="http://www.sphinx-doc.org/">
       Sphinx
      </a>
      4.2.0.
             and
      <a href="https://github.com/bashtage/sphinx-material/">
       Material for
              Sphinx
      </a>
     </div>
    </div>
   </div>
  </footer>
  <script src="../../_static/javascripts/application.js">
  </script>
  <script>
   app.initialize({version: "1.0.4", url: {base: ".."}})
  </script>
 </body>
</html>