<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <meta content="ie=edge" http-equiv="x-ua-compatible"/>
  <meta content="Copy to clipboard" name="lang:clipboard.copy"/>
  <meta content="Copied to clipboard" name="lang:clipboard.copied"/>
  <meta content="en" name="lang:search.language"/>
  <meta content="True" name="lang:search.pipeline.stopwords"/>
  <meta content="True" name="lang:search.pipeline.trimmer"/>
  <meta content="No matching documents" name="lang:search.result.none"/>
  <meta content="1 matching document" name="lang:search.result.one"/>
  <meta content="# matching documents" name="lang:search.result.other"/>
  <meta content="[\s\-]+" name="lang:search.tokenizer"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&amp;display=fallback" rel="stylesheet"/>
  <style>
   body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
  </style>
  <link href="../../_static/stylesheets/application.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-palette.css" rel="stylesheet"/>
  <link href="../../_static/stylesheets/application-fixes.css" rel="stylesheet"/>
  <link href="../../_static/fonts/material-icons.css" rel="stylesheet"/>
  <meta content="#3f51b5" name="theme-color"/>
  <script src="../../_static/javascripts/modernizr.js">
  </script>
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-MJ7RHW2FRB">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-MJ7RHW2FRB');
  </script>
  <title>
   tortoise.queryset — Tortoise ORM v0.18.2 Documentation
  </title>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/material.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <link href="../../_static/tortoise.png" rel="shortcut icon"/>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
 </head>
 <body data-md-color-accent="light-green" data-md-color-primary="green" dir="ltr">
  <svg class="md-svg">
   <defs data-children-count="0">
    <svg height="448" id="__github" viewbox="0 0 416 448" width="416" xmlns="http://www.w3.org/2000/svg">
     <path d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z" fill="currentColor">
     </path>
    </svg>
   </defs>
  </svg>
  <input class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
  <input class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
  <label class="md-overlay" data-md-component="overlay" for="__drawer">
  </label>
  <a class="md-skip" href="#_modules/tortoise/queryset" tabindex="1">
   Skip to content
  </a>
  <header class="md-header" data-md-component="header">
   <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
     <div class="md-flex__cell md-flex__cell--shrink">
      <a class="md-header-nav__button md-logo" href="../../toc.html" title="Tortoise ORM v0.18.2 Documentation">
       <img alt="Tortoise ORM 0.18.2 Documentation logo" height="26" src="../../_static/tortoise.png"/>
      </a>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer">
      </label>
     </div>
     <div class="md-flex__cell md-flex__cell--stretch">
      <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
       <span class="md-header-nav__topic">
        Tortoise ORM
       </span>
       <span class="md-header-nav__topic">
        tortoise.queryset
       </span>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <label class="md-icon md-icon--search md-header-nav__button" for="__search">
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
       <label class="md-search__overlay" for="__search">
       </label>
       <div class="md-search__inner" role="search">
        <form action="../../search.html" class="md-search__form" method="get" name="search">
         <input autocapitalize="off" autocomplete="off" class="md-search__input" data-md-component="query" data-md-state="active" name="q" placeholder="Search" spellcheck="false" type="text"/>
         <label class="md-icon md-search__icon" for="__search">
         </label>
         <button class="md-icon md-search__icon" data-md-component="reset" tabindex="-1" type="reset">
          
         </button>
        </form>
        <div class="md-search__output">
         <div class="md-search__scrollwrap" data-md-scrollfix="">
          <div class="md-search-result" data-md-component="result">
           <div class="md-search-result__meta">
            Type to start searching
           </div>
           <ol class="md-search-result__list">
           </ol>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
     <div class="md-flex__cell md-flex__cell--shrink">
      <div class="md-header-nav__source">
       <a class="md-source" data-md-source="github" href="https://github.com/tortoise/tortoise-orm" title="Go to repository">
        <div class="md-source__icon">
         <svg height="28" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <use height="24" width="24" xlink:href="#__github">
          </use>
         </svg>
        </div>
        <div class="md-source__repository">
         tortoise-orm
        </div>
       </a>
      </div>
     </div>
     <script src="../../_static/javascripts/version_dropdown.js">
     </script>
     <script>
      var json_loc = "../../"versions.json"",
        target_loc = "../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
     </script>
    </div>
   </nav>
  </header>
  <div class="md-container">
   <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
     <ul class="md-tabs__list">
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="../index.html">
        Module code
       </a>
      </li>
      <li class="md-tabs__item">
       <a class="md-tabs__link" href="../tortoise.html">
        tortoise
       </a>
      </li>
     </ul>
    </div>
   </nav>
   <main class="md-main">
    <div class="md-main__inner md-grid" data-md-component="container">
     <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--primary" data-md-level="0">
         <label class="md-nav__title md-nav__title--site" for="__drawer">
          <a class="md-nav__button md-logo" href="../../toc.html" title="Tortoise ORM v0.18.2 Documentation">
           <img alt=" logo" height="48" src="../../_static/tortoise.png" width="48"/>
          </a>
          <a href="../../toc.html" title="Tortoise ORM v0.18.2 Documentation">
           Tortoise ORM
          </a>
         </label>
         <div class="md-nav__source">
          <a class="md-source" data-md-source="github" href="https://github.com/tortoise/tortoise-orm" title="Go to repository">
           <div class="md-source__icon">
            <svg height="28" viewbox="0 0 24 24" width="28" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
             <use height="24" width="24" xlink:href="#__github">
             </use>
            </svg>
           </div>
           <div class="md-source__repository">
            tortoise-orm
           </div>
          </a>
         </div>
         <ul class="md-nav__list">
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../index.html">
            Tortoise ORM
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../getting_started.html">
            Getting started
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../reference.html">
            Reference
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../examples.html">
            Examples
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../contrib.html">
            Contrib
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CHANGELOG.html">
            Changelog
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../roadmap.html">
            Roadmap
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CONTRIBUTING.html">
            Contribution Guide
           </a>
          </li>
          <li class="md-nav__item">
           <a class="md-nav__link" href="../../CONTRIBUTORS.html">
            Thanks
           </a>
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
      <div class="md-sidebar__scrollwrap">
       <div class="md-sidebar__inner">
        <nav class="md-nav md-nav--secondary">
         <ul class="md-nav__list" data-md-scrollfix="">
          <li class="md-nav__item" id="searchbox">
          </li>
         </ul>
        </nav>
       </div>
      </div>
     </div>
     <div class="md-content">
      <article class="md-content__inner md-typeset" role="main">
       <h1 id="modules-tortoise-queryset--page-root">
        Source code for tortoise.queryset
       </h1>
       <div class="highlight">
        <pre>
<span></span><span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterator</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pypika</span> <span class="kn">import</span> <span class="n">JoinType</span><span class="p">,</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">pypika.functions</span> <span class="kn">import</span> <span class="n">Cast</span><span class="p">,</span> <span class="n">Count</span>
<span class="kn">from</span> <span class="nn">pypika.queries</span> <span class="kn">import</span> <span class="n">QueryBuilder</span>
<span class="kn">from</span> <span class="nn">pypika.terms</span> <span class="kn">import</span> <span class="n">Case</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Term</span><span class="p">,</span> <span class="n">ValueWrapper</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Protocol</span>

<span class="kn">from</span> <span class="nn">tortoise.backends.base.client</span> <span class="kn">import</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span> <span class="n">Capabilities</span>
<span class="kn">from</span> <span class="nn">tortoise.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DoesNotExist</span><span class="p">,</span>
    <span class="n">FieldError</span><span class="p">,</span>
    <span class="n">IntegrityError</span><span class="p">,</span>
    <span class="n">MultipleObjectsReturned</span><span class="p">,</span>
    <span class="n">ParamsError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tortoise.expressions</span> <span class="kn">import</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">RawSQL</span>
<span class="kn">from</span> <span class="nn">tortoise.fields.relational</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ForeignKeyFieldInstance</span><span class="p">,</span>
    <span class="n">OneToOneFieldInstance</span><span class="p">,</span>
    <span class="n">RelationalField</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tortoise.functions</span> <span class="kn">import</span> <span class="n">Function</span>
<span class="kn">from</span> <span class="nn">tortoise.query_utils</span> <span class="kn">import</span> <span class="n">Prefetch</span><span class="p">,</span> <span class="n">QueryModifier</span><span class="p">,</span> <span class="n">_get_joins_for_related_field</span>
<span class="kn">from</span> <span class="nn">tortoise.router</span> <span class="kn">import</span> <span class="n">router</span>
<span class="kn">from</span> <span class="nn">tortoise.utils</span> <span class="kn">import</span> <span class="n">chunk</span>

<span class="c1"># Empty placeholder - Should never be edited.</span>

<span class="n">QUERY</span><span class="p">:</span> <span class="n">QueryBuilder</span> <span class="o">=</span> <span class="n">QueryBuilder</span><span class="p">()</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: nocoverage</span>
    <span class="kn">from</span> <span class="nn">tortoise.models</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="n">MODEL</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"MODEL"</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">"Model"</span><span class="p">)</span>
<span class="n">T_co</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">"T_co"</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="QuerySetSingle"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySetSingle">[docs]</a><span class="k">class</span> <span class="nc">QuerySetSingle</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">T_co</span><span class="p">]):</span>
    <span class="sd">"""</span>
<span class="sd">    Awaiting on this will resolve a single instance of the Model object, and not a sequence.</span>
<span class="sd">    """</span>

    <span class="c1"># pylint: disable=W0104</span>
    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">T_co</span><span class="p">]:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">prefetch_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Prefetch</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"QuerySetSingle[MODEL]"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySetSingle[MODEL]"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Function</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySetSingle[MODEL]"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields_for_select</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySetSingle[MODEL]"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">values_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ValuesListQuery"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ValuesQuery"</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># pragma: nocoverage</span></div>


<span class="k">class</span> <span class="nc">AwaitableQuery</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"_joined_tables"</span><span class="p">,</span> <span class="s2">"query"</span><span class="p">,</span> <span class="s2">"model"</span><span class="p">,</span> <span class="s2">"_db"</span><span class="p">,</span> <span class="s2">"capabilities"</span><span class="p">,</span> <span class="s2">"_annotations"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="s2">"Type[Model]"</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">:</span> <span class="n">QueryBuilder</span> <span class="o">=</span> <span class="n">QUERY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">:</span> <span class="n">Capabilities</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_choose_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_write</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseDBAsyncClient</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return the connection that will be used if this query is executed now.</span>

<span class="sd">        :return: BaseDBAsyncClient:</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="k">if</span> <span class="n">for_write</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db</span>

    <span class="k">def</span> <span class="nf">resolve_filters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Builds the common filters for a QuerySet.</span>

<span class="sd">        :param model: The Model this queryset is based on.</span>
<span class="sd">        :param q_objects: The Q expressions to apply.</span>
<span class="sd">        :param annotations: Extra annotations to add.</span>
<span class="sd">        :param custom_filters: Pre-resolved filters to be passed through.</span>
<span class="sd">        """</span>
        <span class="n">has_aggregate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_annotate</span><span class="p">()</span>

        <span class="n">modifier</span> <span class="o">=</span> <span class="n">QueryModifier</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">q_objects</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="n">annotations</span>
            <span class="n">node</span><span class="o">.</span><span class="n">_custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
            <span class="n">modifier</span> <span class="o">&amp;=</span> <span class="n">node</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">)</span>

        <span class="n">where_criterion</span><span class="p">,</span> <span class="n">joins</span><span class="p">,</span> <span class="n">having_criterion</span> <span class="o">=</span> <span class="n">modifier</span><span class="o">.</span><span class="n">get_query_modifiers</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="n">JoinType</span><span class="o">.</span><span class="n">left_outer</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_wheres</span> <span class="o">=</span> <span class="n">where_criterion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_havings</span> <span class="o">=</span> <span class="n">having_criterion</span>

        <span class="k">if</span> <span class="n">has_aggregate</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span> <span class="ow">or</span> <span class="n">having_criterion</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_orderbys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_pk_column</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_join_table_by_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">related_field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">related_field</span><span class="p">:</span> <span class="n">RelationalField</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="n">joins</span> <span class="o">=</span> <span class="n">_get_joins_for_related_field</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">related_field</span><span class="p">,</span> <span class="n">related_field_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">joins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="n">JoinType</span><span class="o">.</span><span class="n">left_outer</span><span class="p">)</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">joins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_resolve_ordering_string</span><span class="p">(</span><span class="n">ordering</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]:</span>
        <span class="n">order_type</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">asc</span>
        <span class="k">if</span> <span class="n">ordering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"-"</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">ordering</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">order_type</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">desc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">ordering</span>

        <span class="k">return</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">order_type</span>

    <span class="k">def</span> <span class="nf">resolve_ordering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Applies standard ordering to QuerySet.</span>

<span class="sd">        :param model: The Model this queryset is based on.</span>
<span class="sd">        :param table: ``pypika.Table`` to keep track of the virtual SQL table</span>
<span class="sd">            (to allow self referential joins)</span>
<span class="sd">        :param orderings: What columns/order to order by</span>
<span class="sd">        :param annotations:  Annotations that may be ordered on</span>

<span class="sd">        :raises FieldError: If a field provided does not exist in model.</span>
<span class="sd">        """</span>
        <span class="c1"># Do not apply default ordering for annotated queries to not mess them up</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">orderings</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">orderings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span>

        <span class="k">for</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="n">orderings</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">ordering</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="s2">"Filtering by relation is not possible. Filter by nested field of related model"</span>
                <span class="p">)</span>

            <span class="n">related_field_name</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">related_field_name</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
                <span class="n">related_field</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RelationalField</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">related_field_name</span><span class="p">])</span>
                <span class="n">related_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_by_field</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">related_field_name</span><span class="p">,</span> <span class="n">related_field</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span>
                    <span class="n">related_field</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                    <span class="n">related_table</span><span class="p">,</span>
                    <span class="p">[(</span><span class="n">forwarded</span><span class="p">,</span> <span class="n">ordering</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                    <span class="p">{},</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">orderby</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordering</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">annotation_info</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">orderby</span><span class="p">(</span><span class="n">annotation_info</span><span class="p">[</span><span class="s2">"field"</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">ordering</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field_object</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">source_field</span> <span class="ow">or</span> <span class="n">field_name</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

                <span class="n">func</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">get_for_dialect</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="s2">"function_cast"</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">field_object</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">orderby</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordering</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_resolve_annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span>
        <span class="n">annotation_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
                <span class="n">annotation_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"joins"</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">"field"</span><span class="p">:</span> <span class="n">annotation</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotation_info</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">annotation_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">join</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s2">"joins"</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_by_field</span><span class="p">(</span><span class="o">*</span><span class="n">join</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_select_other</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">"field"</span><span class="p">]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">"field"</span><span class="p">]</span><span class="o">.</span><span class="n">is_aggregate</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">annotation_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">"""Return the actual SQL."""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_query</span><span class="p">()</span><span class="o">.</span><span class="n">get_sql</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QUERY</span><span class="p">:</span>
        <span class="sd">"""Return the actual query."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>  <span class="c1"># pragma: nocoverage</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>  <span class="c1"># pragma: nocoverage</span>


<div class="viewcode-block" id="QuerySet"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet">[docs]</a><span class="k">class</span> <span class="nc">QuerySet</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"fields"</span><span class="p">,</span>
        <span class="s2">"_prefetch_map"</span><span class="p">,</span>
        <span class="s2">"_prefetch_queries"</span><span class="p">,</span>
        <span class="s2">"_single"</span><span class="p">,</span>
        <span class="s2">"_raise_does_not_exist"</span><span class="p">,</span>
        <span class="s2">"_db"</span><span class="p">,</span>
        <span class="s2">"_limit"</span><span class="p">,</span>
        <span class="s2">"_offset"</span><span class="p">,</span>
        <span class="s2">"_fields_for_select"</span><span class="p">,</span>
        <span class="s2">"_filter_kwargs"</span><span class="p">,</span>
        <span class="s2">"_orderings"</span><span class="p">,</span>
        <span class="s2">"_q_objects"</span><span class="p">,</span>
        <span class="s2">"_distinct"</span><span class="p">,</span>
        <span class="s2">"_having"</span><span class="p">,</span>
        <span class="s2">"_custom_filters"</span><span class="p">,</span>
        <span class="s2">"_group_bys"</span><span class="p">,</span>
        <span class="s2">"_select_for_update"</span><span class="p">,</span>
        <span class="s2">"_select_for_update_nowait"</span><span class="p">,</span>
        <span class="s2">"_select_for_update_skip_locked"</span><span class="p">,</span>
        <span class="s2">"_select_for_update_of"</span><span class="p">,</span>
        <span class="s2">"_select_related"</span><span class="p">,</span>
        <span class="s2">"_select_related_idx"</span><span class="p">,</span>
        <span class="s2">"_use_indexes"</span><span class="p">,</span>
        <span class="s2">"_force_indexes"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Prefetch</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_queries</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">QuerySet</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_single</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_does_not_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields_for_select</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_bys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_nowait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_skip_locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_of</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span>
            <span class="n">Tuple</span><span class="p">[</span><span class="s2">"Type[Model]"</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">"Type[Model]"</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># format with: model,idx,model_name,parent_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_map</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_queries</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_queries</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_single</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_raise_does_not_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_does_not_exist</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_fields_for_select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_for_select</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_filter_kwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filter_kwargs</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_orderings</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_joined_tables</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_q_objects</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_annotations</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_having</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_having</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_custom_filters</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_group_bys</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_bys</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_nowait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_nowait</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_skip_locked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_skip_locked</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_of</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_of</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_related</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_select_related_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span>
        <span class="k">return</span> <span class="n">queryset</span>

    <span class="k">def</span> <span class="nf">_filter_or_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="n">negate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"expected Q objects as args"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_q_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">~</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_q_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_q_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">}))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_q_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">}))</span>

        <span class="k">return</span> <span class="n">queryset</span>

<div class="viewcode-block" id="QuerySet.filter"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Filters QuerySet by given kwargs. You can filter by related objects like this:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            Team.filter(events__tournament__name='Test')</span>

<span class="sd">        You can also pass Q objects to filters as args.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_or_exclude</span><span class="p">(</span><span class="n">negate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.exclude"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.exclude">[docs]</a>    <span class="k">def</span> <span class="nf">exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Same as .filter(), but with appends all args with NOT</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_or_exclude</span><span class="p">(</span><span class="n">negate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.order_by"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.order_by">[docs]</a>    <span class="k">def</span> <span class="nf">order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">orderings</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Accept args to filter by in format like this:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            .order_by('name', '-tournament__name')</span>

<span class="sd">        Supports ordering by related models too.</span>
<span class="sd">        A '-' before the name will result in descending sort order, default is ascending.</span>

<span class="sd">        :raises FieldError: If unknown field has been provided.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">new_ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ordering</span> <span class="ow">in</span> <span class="n">orderings</span><span class="p">:</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">order_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_ordering_string</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">field_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
                <span class="ow">or</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">new_ordering</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">order_type</span><span class="p">))</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_orderings</span> <span class="o">=</span> <span class="n">new_ordering</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.limit"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.limit">[docs]</a>    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Limits QuerySet to given length.</span>

<span class="sd">        :raises ParamsError: Limit should be non-negative number.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParamsError</span><span class="p">(</span><span class="s2">"Limit should be non-negative number"</span><span class="p">)</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.offset"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.offset">[docs]</a>    <span class="k">def</span> <span class="nf">offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Query offset for QuerySet.</span>

<span class="sd">        :raises ParamsError: Offset should be non-negative number.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParamsError</span><span class="p">(</span><span class="s2">"Offset should be non-negative number"</span><span class="p">)</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">requires_limit</span> <span class="ow">and</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.distinct"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.distinct">[docs]</a>    <span class="k">def</span> <span class="nf">distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet distinct.</span>

<span class="sd">        Only makes sense in combination with a ``.values()`` or ``.values_list()`` as it</span>
<span class="sd">        precedes all the fetched fields with a distinct.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.select_for_update"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.select_for_update">[docs]</a>    <span class="k">def</span> <span class="nf">select_for_update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">nowait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">skip_locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">of</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet select for update.</span>

<span class="sd">        Returns a queryset that will lock rows until the end of the transaction,</span>
<span class="sd">        generating a SELECT ... FOR UPDATE SQL statement on supported databases.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_for_update</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_nowait</span> <span class="o">=</span> <span class="n">nowait</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_skip_locked</span> <span class="o">=</span> <span class="n">skip_locked</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_select_for_update_of</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">of</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">queryset</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="QuerySet.annotate"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.annotate">[docs]</a>    <span class="k">def</span> <span class="nf">annotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Expression</span><span class="p">,</span> <span class="n">Term</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Annotate result with aggregation or function result.</span>

<span class="sd">        :raises TypeError: Value of kwarg is expected to be a ``Function`` instance.</span>
<span class="sd">        """</span>
        <span class="kn">from</span> <span class="nn">tortoise.models</span> <span class="kn">import</span> <span class="n">get_filters_for_field</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># if not isinstance(annotation, (Function, Term)):</span>
            <span class="c1">#     raise TypeError("value is expected to be Function/Term instance")</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_annotations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_custom_filters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_filters_for_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.group_by"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.group_by">[docs]</a>    <span class="k">def</span> <span class="nf">group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet returns list of dict or tuple with group by.</span>

<span class="sd">        Must call before .values() or .values_list()</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_group_bys</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.values_list"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.values_list">[docs]</a>    <span class="k">def</span> <span class="nf">values_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields_</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">flat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ValuesListQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet returns list of tuples for given args instead of objects.</span>

<span class="sd">        If call after `.get()`, `.get_or_none()` or `.first()` return tuples for given args instead of object.</span>

<span class="sd">        If ```flat=True`` and only one arg is passed can return flat list or just scalar.</span>

<span class="sd">        If no arguments are passed it will default to a tuple containing all fields</span>
<span class="sd">        in order of declaration.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">ValuesListQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">single</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_single</span><span class="p">,</span>
            <span class="n">raise_does_not_exist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_raise_does_not_exist</span><span class="p">,</span>
            <span class="n">flat</span><span class="o">=</span><span class="n">flat</span><span class="p">,</span>
            <span class="n">fields_for_select_list</span><span class="o">=</span><span class="n">fields_</span>  <span class="c1"># type: ignore</span>
            <span class="ow">or</span> <span class="p">[</span>
                <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span>
            <span class="p">]</span>
            <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">distinct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span>
            <span class="n">orderings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">group_bys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_bys</span><span class="p">,</span>
            <span class="n">force_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">,</span>
            <span class="n">use_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.values"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ValuesQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Make QuerySet return dicts instead of objects.</span>

<span class="sd">        If call after `.get()`, `.get_or_none()` or `.first()` return dict instead of object.</span>

<span class="sd">        Can pass names of fields to fetch, or as a ``field_name='name_in_dict'`` kwarg.</span>

<span class="sd">        If no arguments are passed it will default to a dict containing all fields.</span>

<span class="sd">        :raises FieldError: If duplicate key has been provided.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fields_for_select</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_for_select</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Duplicate key </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">fields_for_select</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

            <span class="k">for</span> <span class="n">return_as</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">return_as</span> <span class="ow">in</span> <span class="n">fields_for_select</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Duplicate key </span><span class="si">{</span><span class="n">return_as</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">fields_for_select</span><span class="p">[</span><span class="n">return_as</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">field</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">fields_for_select</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">_fields</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">ValuesQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">single</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_single</span><span class="p">,</span>
            <span class="n">raise_does_not_exist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_raise_does_not_exist</span><span class="p">,</span>
            <span class="n">fields_for_select</span><span class="o">=</span><span class="n">fields_for_select</span><span class="p">,</span>
            <span class="n">distinct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span>
            <span class="n">orderings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">group_bys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_bys</span><span class="p">,</span>
            <span class="n">force_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">,</span>
            <span class="n">use_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.delete"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"DeleteQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Delete all objects in QuerySet.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">DeleteQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">orderings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.update"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"UpdateQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Update all objects in QuerySet with given kwargs.</span>

<span class="sd">        .. admonition: Example:</span>

<span class="sd">            .. code-block:: py3</span>

<span class="sd">                await Employee.filter(occupation='developer').update(salary=5000)</span>

<span class="sd">        Will instead of returning a resultset, update the data in the DB itself.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">UpdateQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">update_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">orderings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.count"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"CountQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return count of objects in queryset instead of objects.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">CountQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span>
            <span class="n">force_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">,</span>
            <span class="n">use_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.exists"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"ExistsQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return True/False whether queryset exists.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">ExistsQuery</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">force_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">,</span>
            <span class="n">use_indexes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.all"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.all">[docs]</a>    <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return the whole QuerySet.</span>
<span class="sd">        Essentially a no-op except as the only operation.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span></div>

<div class="viewcode-block" id="QuerySet.raw"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.raw">[docs]</a>    <span class="k">def</span> <span class="nf">raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"RawSQLQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return the QuerySet from raw SQL</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">RawSQLQuery</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.first"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.first">[docs]</a>    <span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="sd">"""</span>
<span class="sd">        Limit queryset to one object and return one object instead of list.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_single</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">queryset</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="QuerySet.get"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetch exactly one object matching the parameters.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_single</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_raise_does_not_exist</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">queryset</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="QuerySet.in_bulk"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.in_bulk">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">in_bulk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">id_list</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MODEL</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Return a dictionary mapping each of the given IDs to the object with</span>
<span class="sd">        that ID. If `id_list` isn't provided, evaluate the entire QuerySet.</span>

<span class="sd">        :param id_list: A list of field values</span>
<span class="sd">        :param field_name: Must be a unique field</span>
<span class="sd">        """</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">__in"</span><span class="p">:</span> <span class="n">id_list</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span> <span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">}</span></div>

<div class="viewcode-block" id="QuerySet.bulk_create"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.bulk_create">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_create</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_conflicts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">update_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_conflict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BulkCreateQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        This method inserts the provided list of objects into the database in an efficient manner</span>
<span class="sd">        (generally only 1 query, no matter how many objects there are),</span>
<span class="sd">        and returns created objects as a list, in the same order as provided</span>

<span class="sd">        :param on_conflict: On conflict index name</span>
<span class="sd">        :param update_fields: Update fields when conflicts</span>
<span class="sd">        :param ignore_conflicts: Ignore conflicts when inserting</span>
<span class="sd">        :param objects: List of objects to bulk create</span>
<span class="sd">        :param batch_size: How many objects are created in a single query</span>

<span class="sd">        :raises ValueError: If params do not meet specifications</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">ignore_conflicts</span> <span class="ow">and</span> <span class="n">update_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"ignore_conflicts and update_fields are mutually exclusive."</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_conflicts</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">update_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">on_conflict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">on_conflict</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update_fields</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"update_fields and on_conflict need set in same time."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BulkCreateQuery</span><span class="p">(</span>  <span class="c1"># type:ignore</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">ignore_conflicts</span><span class="o">=</span><span class="n">ignore_conflicts</span><span class="p">,</span>
            <span class="n">update_fields</span><span class="o">=</span><span class="n">update_fields</span><span class="p">,</span>
            <span class="n">on_conflict</span><span class="o">=</span><span class="n">on_conflict</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.bulk_update"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.bulk_update">[docs]</a>    <span class="k">def</span> <span class="nf">bulk_update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"BulkUpdateQuery"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Update the given fields in each of the given objects in the database.</span>

<span class="sd">        :param objects: List of objects to bulk create</span>
<span class="sd">        :param fields: The fields to update</span>
<span class="sd">        :param batch_size: How many objects are created in a single query</span>

<span class="sd">        :raises ValueError: If objects have no primary key set</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"All bulk_update() objects must have a primary key set."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BulkUpdateQuery</span><span class="p">(</span>  <span class="c1"># type:ignore</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">,</span>
            <span class="n">orderings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span>
            <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
            <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.get_or_none"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.get_or_none">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Q</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuerySetSingle</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetch exactly one object matching the parameters.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_single</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">queryset</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="QuerySet.only"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.only">[docs]</a>    <span class="k">def</span> <span class="nf">only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields_for_select</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Fetch ONLY the specified fields to create a partial model.</span>

<span class="sd">        Persisting changes on the model is allowed only when:</span>

<span class="sd">        * All the fields you want to update is specified in ``&lt;model&gt;.save(update_fields=[...])``</span>
<span class="sd">        * You included the Model primary key in the `.only(...)``</span>

<span class="sd">        To protect against common mistakes we ensure that errors get raised:</span>

<span class="sd">        * If you access a field that is not specified, you will get an ``AttributeError``.</span>
<span class="sd">        * If you do a ``&lt;model&gt;.save()`` a ``IncompleteInstanceError`` will be raised as the model is, as requested, incomplete.</span>
<span class="sd">        * If you do a ``&lt;model&gt;.save(update_fields=[...])`` and you didn't include the primary key in the ``.only(...)``,</span>
<span class="sd">          then ``IncompleteInstanceError`` will be raised indicating that updates can't be done without the primary key being known.</span>
<span class="sd">        * If you do a ``&lt;model&gt;.save(update_fields=[...])`` and one of the fields in ``update_fields`` was not in the ``.only(...)``,</span>
<span class="sd">          then ``IncompleteInstanceError`` as that field is not available to be updated.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_fields_for_select</span> <span class="o">=</span> <span class="n">fields_for_select</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.select_related"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.select_related">[docs]</a>    <span class="k">def</span> <span class="nf">select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fields</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Return a new QuerySet instance that will select related objects.</span>

<span class="sd">        If fields are specified, they must be ForeignKey fields and only those</span>
<span class="sd">        related objects are included in the selection.</span>
<span class="sd">        """</span>

        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">queryset</span><span class="o">.</span><span class="n">_select_related</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.force_index"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.force_index">[docs]</a>    <span class="k">def</span> <span class="nf">force_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        The FORCE INDEX hint acts like USE INDEX (index_list),</span>
<span class="sd">        with the addition that a table scan is assumed to be very expensive.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_index_hint</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">index_names</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_force_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">queryset</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="QuerySet.use_index"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.use_index">[docs]</a>    <span class="k">def</span> <span class="nf">use_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">index_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        The USE INDEX (index_list) hint tells MySQL to use only one of the named indexes to find rows in the table.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_index_hint</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">index_names</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_use_indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">queryset</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="QuerySet.prefetch_related"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.prefetch_related">[docs]</a>    <span class="k">def</span> <span class="nf">prefetch_related</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Prefetch</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Like ``.fetch_related()`` on instance, but works on all objects in QuerySet.</span>

<span class="sd">        :raises FieldError: If the field to prefetch on is not a relation, or not found.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">relation</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relation</span><span class="p">,</span> <span class="n">Prefetch</span><span class="p">):</span>
                <span class="n">relation</span><span class="o">.</span><span class="n">resolve_for_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">first_level_field</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_prefetch</span> <span class="o">=</span> <span class="n">relation</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">first_level_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">first_level_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"Field </span><span class="si">{</span><span class="n">first_level_field</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> is not a relation"</span>
                    <span class="p">)</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"Relation </span><span class="si">{</span><span class="n">first_level_field</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> not found"</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">first_level_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="p">[</span><span class="n">first_level_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">forwarded_prefetch</span><span class="p">:</span>
                <span class="n">queryset</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="p">[</span><span class="n">first_level_field</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">forwarded_prefetch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

<div class="viewcode-block" id="QuerySet.explain"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.explain">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">"""Fetch and return information about the query execution plan.</span>

<span class="sd">        This is done by executing an ``EXPLAIN`` query whose exact prefix depends</span>
<span class="sd">        on the database backend, as documented below.</span>

<span class="sd">        - PostgreSQL: ``EXPLAIN (FORMAT JSON, VERBOSE) ...``</span>
<span class="sd">        - SQLite: ``EXPLAIN QUERY PLAN ...``</span>
<span class="sd">        - MySQL: ``EXPLAIN FORMAT=JSON ...``</span>

<span class="sd">        .. note::</span>
<span class="sd">            This is only meant to be used in an interactive environment for debugging</span>
<span class="sd">            and query optimization.</span>
<span class="sd">            **The output format may (and will) vary greatly depending on the database backend.**</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span><span class="o">.</span><span class="n">execute_explain</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="QuerySet.using_db"><a class="viewcode-back" href="../../query.html#tortoise.queryset.QuerySet.using_db">[docs]</a>    <span class="k">def</span> <span class="nf">using_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"QuerySet[MODEL]"</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Executes query in provided db client.</span>
<span class="sd">        Useful for transactions workaround.</span>
<span class="sd">        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">()</span>
        <span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">_db</span>
        <span class="k">return</span> <span class="n">queryset</span></div>

    <span class="k">def</span> <span class="nf">_join_table_with_select_related</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="s2">"Type[Model]"</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
        <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">forwarded_fields</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Table</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span> <span class="ow">and</span> <span class="n">forwarded_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">" is not relation'</span><span class="p">)</span>

        <span class="n">field_object</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RelationalField</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Unknown field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_by_field</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_object</span><span class="p">)</span>
        <span class="n">related_fields</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span>
        <span class="n">append_item</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_fields</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">related_field</span> <span class="ow">in</span> <span class="n">related_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">table</span><span class="p">[</span><span class="n">related_field</span><span class="p">]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">table</span><span class="o">.</span><span class="n">get_table_name</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">related_field</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">forwarded_fields</span><span class="p">:</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields_</span> <span class="o">=</span> <span class="n">forwarded_fields</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_with_select_related</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">forwarded_fields</span><span class="o">=</span><span class="n">forwarded_fields_</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># clean tmp records first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_joined_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_for_select</span><span class="p">:</span>
            <span class="n">append_item</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields_for_select</span><span class="p">),</span> <span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">append_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_item</span><span class="p">)</span>
            <span class="n">db_fields_for_select</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_for_select</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">db_fields_for_select</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery_all_fields</span><span class="p">)</span>
            <span class="n">append_item</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_fields</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">),</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">append_item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">append_item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_distinct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">for_update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_nowait</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_skip_locked</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update_of</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_related</span><span class="p">:</span>
                <span class="n">field</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_with_select_related</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                    <span class="n">forwarded_fields</span><span class="o">=</span><span class="n">forwarded_fields</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">force_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_force_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_use_indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_for_update</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">val</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="n">instance_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
            <span class="n">prefetch_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_map</span><span class="p">,</span>
            <span class="n">prefetch_queries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_queries</span><span class="p">,</span>
            <span class="n">select_related_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_related_idx</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">execute_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">custom_fields</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">instance_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_does_not_exist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">"Object does not exist"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span> <span class="n">MultipleObjectsReturned</span><span class="p">(</span><span class="s2">"Multiple objects returned, expected exactly one"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance_list</span></div>


<div class="viewcode-block" id="UpdateQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.UpdateQuery">[docs]</a><span class="k">class</span> <span class="nc">UpdateQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"update_kwargs"</span><span class="p">,</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"orderings"</span><span class="p">,</span>
        <span class="s2">"limit"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">update_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_kwargs</span> <span class="o">=</span> <span class="n">update_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span> <span class="o">=</span> <span class="n">orderings</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query_class</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_update_limit_order_by</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Need to get executor to get correct column_map</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown keyword argument </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_object</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Field </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is PK and can not be updated"</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_object</span><span class="p">,</span> <span class="p">(</span><span class="n">ForeignKeyFieldInstance</span><span class="p">,</span> <span class="n">OneToOneFieldInstance</span><span class="p">)):</span>
                <span class="n">fk_field</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field_object</span><span class="o">.</span><span class="n">source_field</span>  <span class="c1"># type: ignore</span>
                <span class="n">db_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">fk_field</span><span class="p">]</span><span class="o">.</span><span class="n">source_field</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">fk_field</span><span class="p">](</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_object</span><span class="o">.</span><span class="n">to_field_instance</span><span class="o">.</span><span class="n">model_field_name</span><span class="p">),</span> <span class="kc">None</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">db_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Field </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is virtual and can not be updated"</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Term</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">resolver_arithmetic_expression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">)[</span><span class="s2">"field"</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="DeleteQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.DeleteQuery">[docs]</a><span class="k">class</span> <span class="nc">DeleteQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"orderings"</span><span class="p">,</span>
        <span class="s2">"limit"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span> <span class="o">=</span> <span class="n">orderings</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_update_limit_order_by</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_delete_from</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ExistsQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.ExistsQuery">[docs]</a><span class="k">class</span> <span class="nc">ExistsQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"force_indexes"</span><span class="p">,</span>
        <span class="s2">"use_indexes"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">force_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">use_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span> <span class="o">=</span> <span class="n">force_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span> <span class="o">=</span> <span class="n">use_indexes</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_select_other</span><span class="p">(</span><span class="n">ValueWrapper</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">force_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="CountQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.CountQuery">[docs]</a><span class="k">class</span> <span class="nc">CountQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"limit"</span><span class="p">,</span>
        <span class="s2">"offset"</span><span class="p">,</span>
        <span class="s2">"force_indexes"</span><span class="p">,</span>
        <span class="s2">"use_indexes"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">force_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">use_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span> <span class="o">=</span> <span class="n">force_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span> <span class="o">=</span> <span class="n">use_indexes</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_select_other</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s2">"*"</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">force_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="FieldSelectQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.FieldSelectQuery">[docs]</a><span class="k">class</span> <span class="nc">FieldSelectQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="c1"># pylint: disable=W0223</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"annotations"</span><span class="p">,)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">def</span> <span class="nf">_join_table_with_forwarded_fields</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">forwarded_fields</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Table</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">forwarded_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span> <span class="ow">and</span> <span class="n">forwarded_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">" is not relation'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">forwarded_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">'Selecting relation "</span><span class="si">{}</span><span class="s1">" is not possible, select concrete '</span>
                <span class="s2">"field on related model"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">field_object</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">RelationalField</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_object</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Unknown field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_by_field</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_object</span><span class="p">)</span>
        <span class="n">field</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields_</span> <span class="o">=</span> <span class="n">forwarded_fields</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_with_forwarded_fields</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">field_object</span><span class="o">.</span><span class="n">related_model</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
            <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
            <span class="n">forwarded_fields</span><span class="o">=</span><span class="n">forwarded_fields_</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_field_to_select_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_as</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">[</span><span class="n">return_as</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">:</span>
            <span class="n">db_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_db_projection</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_select_field</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">db_field</span><span class="p">]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">return_as</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">'Selecting relation "</span><span class="si">{}</span><span class="s1">" is not possible, select '</span>
                <span class="s2">"concrete field on related model"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">field_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
            <span class="n">related_table</span><span class="p">,</span> <span class="n">related_db_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_with_forwarded_fields</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">field_</span><span class="p">,</span>
                <span class="n">forwarded_fields</span><span class="o">=</span><span class="n">forwarded_fields</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_select_field</span><span class="p">(</span><span class="n">related_table</span><span class="p">[</span><span class="n">related_db_field</span><span class="p">]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">return_as</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Unknown field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve_to_python_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
            <span class="c1"># return as is to get whole model objects</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_native_fields</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="n">field_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">"field_object"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_object</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">field_object</span><span class="o">.</span><span class="n">to_python_value</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">to_python_value</span>

        <span class="n">field_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fetch_fields</span><span class="p">:</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">field_</span><span class="p">]</span><span class="o">.</span><span class="n">related_model</span>  <span class="c1"># type: ignore</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_to_python_value</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="n">forwarded_fields</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">FieldError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Unknown field "</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">" for model "</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_group_bys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">field_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">group_bys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_annotations</span><span class="p">:</span>
                <span class="n">group_bys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Term</span><span class="p">(</span><span class="n">field_name</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">forwarded_fields</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">"__"</span><span class="p">)</span>
            <span class="n">related_table</span><span class="p">,</span> <span class="n">related_db_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_table_with_forwarded_fields</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">forwarded_fields</span><span class="o">=</span><span class="n">forwarded_fields</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">related_table</span><span class="p">[</span><span class="n">related_db_field</span><span class="p">]</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">group_bys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group_bys</span></div>


<div class="viewcode-block" id="ValuesListQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.ValuesListQuery">[docs]</a><span class="k">class</span> <span class="nc">ValuesListQuery</span><span class="p">(</span><span class="n">FieldSelectQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"flat"</span><span class="p">,</span>
        <span class="s2">"fields"</span><span class="p">,</span>
        <span class="s2">"limit"</span><span class="p">,</span>
        <span class="s2">"offset"</span><span class="p">,</span>
        <span class="s2">"distinct"</span><span class="p">,</span>
        <span class="s2">"orderings"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"single"</span><span class="p">,</span>
        <span class="s2">"raise_does_not_exist"</span><span class="p">,</span>
        <span class="s2">"fields_for_select_list"</span><span class="p">,</span>
        <span class="s2">"group_bys"</span><span class="p">,</span>
        <span class="s2">"force_indexes"</span><span class="p">,</span>
        <span class="s2">"use_indexes"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">single</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">raise_does_not_exist</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">fields_for_select_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">distinct</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">flat</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">group_bys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">force_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">use_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flat</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields_for_select_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">"You can flat value_list only if contains one field"</span><span class="p">)</span>

        <span class="n">fields_for_select</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">field</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_for_select_list</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields_for_select</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">distinct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span> <span class="o">=</span> <span class="n">orderings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="n">single</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_does_not_exist</span> <span class="o">=</span> <span class="n">raise_does_not_exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_for_select_list</span> <span class="o">=</span> <span class="n">fields_for_select_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span> <span class="o">=</span> <span class="n">group_bys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span> <span class="o">=</span> <span class="n">force_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span> <span class="o">=</span> <span class="n">use_indexes</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">positional_number</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_field_to_select_query</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">positional_number</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_groupbys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_group_bys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">force_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>  <span class="c1"># pylint: disable=E1101</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">val</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">]:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_to_python_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">flatmap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">"0"</span><span class="p">])</span>  <span class="c1"># noqa</span>
            <span class="n">lst_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">flatmap</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">listmap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">entry</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">column</span><span class="p">])</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>  <span class="c1"># noqa</span>
            <span class="n">lst_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">listmap</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lst_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lst_values</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_does_not_exist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">"Object does not exist"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span> <span class="n">MultipleObjectsReturned</span><span class="p">(</span><span class="s2">"Multiple objects returned, expected exactly one"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lst_values</span></div>


<div class="viewcode-block" id="ValuesQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.ValuesQuery">[docs]</a><span class="k">class</span> <span class="nc">ValuesQuery</span><span class="p">(</span><span class="n">FieldSelectQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"fields_for_select"</span><span class="p">,</span>
        <span class="s2">"limit"</span><span class="p">,</span>
        <span class="s2">"offset"</span><span class="p">,</span>
        <span class="s2">"distinct"</span><span class="p">,</span>
        <span class="s2">"orderings"</span><span class="p">,</span>
        <span class="s2">"annotations"</span><span class="p">,</span>
        <span class="s2">"custom_filters"</span><span class="p">,</span>
        <span class="s2">"q_objects"</span><span class="p">,</span>
        <span class="s2">"single"</span><span class="p">,</span>
        <span class="s2">"raise_does_not_exist"</span><span class="p">,</span>
        <span class="s2">"group_bys"</span><span class="p">,</span>
        <span class="s2">"force_indexes"</span><span class="p">,</span>
        <span class="s2">"use_indexes"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">single</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">raise_does_not_exist</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">fields_for_select</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">offset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">distinct</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">group_bys</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">force_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">use_indexes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_for_select</span> <span class="o">=</span> <span class="n">fields_for_select</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span> <span class="o">=</span> <span class="n">distinct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span> <span class="o">=</span> <span class="n">orderings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span> <span class="o">=</span> <span class="n">custom_filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span> <span class="o">=</span> <span class="n">q_objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="n">single</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_does_not_exist</span> <span class="o">=</span> <span class="n">raise_does_not_exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span> <span class="o">=</span> <span class="n">group_bys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span> <span class="o">=</span> <span class="n">force_indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span> <span class="o">=</span> <span class="n">use_indexes</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basequery</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">return_as</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_for_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_field_to_select_query</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">return_as</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distinct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_groupbys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_group_bys</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">group_bys</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_force_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">force_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">force_indexes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_use_indexes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">use_index</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">use_indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>  <span class="c1"># pylint: disable=E1101</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="k">await</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">val</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query_dict</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">val</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_to_python_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_for_select</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">types</span><span class="o">.</span><span class="n">LambdaType</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">single</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_does_not_exist</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">"Object does not exist"</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span> <span class="n">MultipleObjectsReturned</span><span class="p">(</span><span class="s2">"Multiple objects returned, expected exactly one"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="RawSQLQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.RawSQLQuery">[docs]</a><span class="k">class</span> <span class="nc">RawSQLQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"_sql"</span><span class="p">,</span> <span class="s2">"_db"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span> <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="n">sql</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">RawSQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">instance_list</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">execute_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance_list</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span></div>


<div class="viewcode-block" id="BulkUpdateQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.BulkUpdateQuery">[docs]</a><span class="k">class</span> <span class="nc">BulkUpdateQuery</span><span class="p">(</span><span class="n">UpdateQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"objects"</span><span class="p">,</span> <span class="s2">"fields"</span><span class="p">,</span> <span class="s2">"batch_size"</span><span class="p">,</span> <span class="s2">"queries"</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">q_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span>
        <span class="n">annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">custom_filters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">orderings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">fields</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">{},</span> <span class="n">db</span><span class="p">,</span> <span class="n">q_objects</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">custom_filters</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">orderings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">QUERY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">basetable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">query_class</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="o">.</span><span class="n">support_update_limit_order_by</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_ordering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orderings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_filters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="n">q_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q_objects</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">custom_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_filters</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="n">pk_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk_attr</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">pk_attr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">objects_item</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">()</span>
                <span class="n">pk_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects_item</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">pk_attr</span><span class="p">](</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">field_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="k">case</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                        <span class="n">pk</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span>
                        <span class="n">Cast</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_wrapper_cls</span><span class="p">(</span><span class="n">field_value</span><span class="p">),</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields_map</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">get_for_dialect</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">schema_generator</span><span class="o">.</span><span class="n">DIALECT</span><span class="p">,</span> <span class="s2">"SQL_TYPE"</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">schema_generator</span><span class="o">.</span><span class="n">DIALECT</span> <span class="o">==</span> <span class="s2">"postgres"</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_wrapper_cls</span><span class="p">(</span><span class="n">field_value</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">pk_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pk_list</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="BulkUpdateQuery.sql"><a class="viewcode-back" href="../../query.html#tortoise.queryset.BulkUpdateQuery.sql">[docs]</a>    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">as_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">";"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="k">for</span> <span class="n">query</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queries</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="BulkCreateQuery"><a class="viewcode-back" href="../../query.html#tortoise.queryset.BulkCreateQuery">[docs]</a><span class="k">class</span> <span class="nc">BulkCreateQuery</span><span class="p">(</span><span class="n">AwaitableQuery</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"objects"</span><span class="p">,</span>
        <span class="s2">"ignore_conflicts"</span><span class="p">,</span>
        <span class="s2">"batch_size"</span><span class="p">,</span>
        <span class="s2">"_db"</span><span class="p">,</span>
        <span class="s2">"executor"</span><span class="p">,</span>
        <span class="s2">"insert_query"</span><span class="p">,</span>
        <span class="s2">"insert_query_all"</span><span class="p">,</span>
        <span class="s2">"update_fields"</span><span class="p">,</span>
        <span class="s2">"on_conflict"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">BaseDBAsyncClient</span><span class="p">,</span>
        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">MODEL</span><span class="p">],</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_conflicts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">update_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_conflict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_conflicts</span> <span class="o">=</span> <span class="n">ignore_conflicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_fields</span> <span class="o">=</span> <span class="n">update_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_conflict</span> <span class="o">=</span> <span class="n">on_conflict</span>

    <span class="k">def</span> <span class="nf">_make_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">executor_class</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_conflicts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">insert_query_all</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">insert_query</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">regular_columns</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">_prepare_insert_columns</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">_prepare_insert_statement</span><span class="p">(</span>
                <span class="n">columns</span><span class="p">,</span> <span class="n">ignore_conflicts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_conflicts</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">generated_db_fields</span><span class="p">:</span>
                <span class="n">regular_columns_all</span><span class="p">,</span> <span class="n">columns_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">_prepare_insert_columns</span><span class="p">(</span>
                    <span class="n">include_generated</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">_prepare_insert_statement</span><span class="p">(</span>
                    <span class="n">columns_all</span><span class="p">,</span> <span class="n">has_generated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_conflicts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ignore_conflicts</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fields</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"new_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="si">}</span><span class="s2">"</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span>  <span class="c1"># type:ignore</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">on_conflict</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span><span class="o">.</span><span class="n">on_conflict</span><span class="p">(</span>  <span class="c1"># type:ignore</span>
                    <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">on_conflict</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">update_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_fields</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="o">.</span><span class="n">do_update</span><span class="p">(</span>  <span class="c1"># type:ignore</span>
                        <span class="n">update_field</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span><span class="o">.</span><span class="n">do_update</span><span class="p">(</span><span class="n">update_field</span><span class="p">)</span>  <span class="c1"># type:ignore</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">instance_chunk</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">values_lists_all</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values_lists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instance_chunk</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_custom_generated_pk</span><span class="p">:</span>
                    <span class="n">values_lists_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">field_name</span><span class="p">](</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field_name</span><span class="p">),</span> <span class="n">instance</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">regular_columns_all</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">column_map</span><span class="p">[</span><span class="n">field_name</span><span class="p">](</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field_name</span><span class="p">),</span> <span class="n">instance</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">regular_columns</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">if</span> <span class="n">values_lists_all</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_many</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="p">),</span> <span class="n">values_lists_all</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">values_lists</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute_many</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span><span class="p">),</span> <span class="n">values_lists</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>

    <span class="k">def</span> <span class="fm">__await__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">MODEL</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_choose_db</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute</span><span class="p">()</span><span class="o">.</span><span class="fm">__await__</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

<div class="viewcode-block" id="BulkCreateQuery.sql"><a class="viewcode-back" href="../../query.html#tortoise.queryset.BulkCreateQuery.sql">[docs]</a>    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">as_query</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">";"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="p">)])</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">insert_query</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_query_all</span><span class="p">)</span></div></div>
</pre>
       </div>
      </article>
     </div>
    </div>
   </main>
  </div>
  <footer class="md-footer">
   <div class="md-footer-nav">
    <nav class="md-footer-nav__inner md-grid">
    </nav>
   </div>
   <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
     <div class="md-footer-copyright">
      <div class="md-footer-copyright__highlight">
       © Copyright 2018 - 2022, Andrey Bondar &amp; Nickolas Grigoriadis &amp; long2ice.
      </div>
      Created using
      <a href="http://www.sphinx-doc.org/">
       Sphinx
      </a>
      4.3.2.
             and
      <a href="https://github.com/bashtage/sphinx-material/">
       Material for
              Sphinx
      </a>
     </div>
    </div>
   </div>
  </footer>
  <script src="../../_static/javascripts/application.js">
  </script>
  <script>
   app.initialize({version: "1.0.4", url: {base: ".."}})
  </script>
 </body>
</html>